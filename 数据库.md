# 数据库

Bamboo中，默认支持两种数据库，mongodb和redis。Mongodb是bamboo的主存储机构，redis是bamboo的缓存以及数据结构中间件。

Bamboo的ORM构建在mongodb上。Session由redis实现。

## 数据库的连接

### mongodb的连接

    local mongo = require 'bamboo.db.mongo'
    local db = mongo.connect({
      host = "192.168.1.100",
      port = 27017,
      db = 'dbname',
      user = 'user',          -- optional
      password = 'password'   -- optional
    })

这个连接，可以放在`handler_entry.lua`的执行区执行，也可以放在这个文件的`init()`函数中执行。区别在于，前者，只在进程启动的时候，执行一次。而后者，在每个请求进来的时候，都会执行一次。

### redis的连接

    local redis = require 'bamboo.db.redis'
    local db = redis.connect({
      host = "192.168.1.100",
      port = 6379,
      db = n,
      auth = 'password'   -- optional
    })

这个连接，可以放在`handler_entry.lua`的执行区执行，也可以放在这个文件的`init()`函数中执行。区别在于，前者，只在进程启动的时候，执行一次。而后者，在每个请求进来的时候，都会执行一次。

redis中还有一个连接函数：`connectAll()`，它支持master-slave配置的redis。它的参数形式为：

    local redis = require 'bamboo.db.redis'
    local db = redis.connectAll({
      master = {
        host = "192.168.1.100",
        port = 6379,
        db = n,
        auth = 'password'   -- optional
      },
      slaves = {
        { host = 'xxx', port=xxx, db=xxx, auth=xxx},
        { host = 'xxx', port=xxx, db=xxx, auth=xxx},
        { host = 'xxx', port=xxx, db=xxx, auth=xxx},
        ....
      }
    })

返回的`db`数据库连接对象。跟普通的一样的使用方法，但它在内部对读写作了分离，写是写到master，读是按了算法选择redis中的某一个做读操作。

更准确地说，redis在bamboo中的角色，是缓存和数据结构中间件的角色。用活了，很强大。

### 注
1. 老版本用到了`BAMBOO_DB`这个全局变量。在新版中，需要在引入了数据库连接后，自行导出到全局表中；
2. 模型的引用，需要先将mongodb和redis连接上之后，再通过`bamboo.registerModel()`函数，将数据库连接传入，后面才能开始使用模型。

